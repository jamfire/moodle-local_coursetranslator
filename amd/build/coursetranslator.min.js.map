{"version":3,"file":"coursetranslator.min.js","sources":["../src/coursetranslator.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/*\n * @module     local_coursetranslator/coursetranslator\n * @copyright  2022 Kaleb Heitzman <kaleb@jamfire.io>\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\n// import libs\nimport ajax from \"core/ajax\";\nimport * as str from \"core/str\";\n\n/**\n * Translation Editor UI\n * @param {Object} config JS Config\n */\nexport const init = (config) => {\n\n  // Autosave Translation String\n  let autosavedMsg = \"\";\n  str.get_string(\"t_autosaved\", \"local_coursetranslator\").done((string) => {\n    autosavedMsg = string;\n  });\n\n  /**\n   * Convert a template string into HTML DOM nodes\n   * @param  {String} string The template string\n   * @return {Node}       The template HTML\n   */\n  const stringToHTML = (string) => {\n    // See if DOMParser is supported\n    var support = (() => {\n      if (!window.DOMParser) {\n        return false;\n      }\n      var parser = new DOMParser();\n      try {\n        parser.parseFromString(\"x\", \"text/html\");\n      } catch (err) {\n        return false;\n      }\n      return true;\n    })();\n\n    // If DOMParser is supported, use it\n    if (support) {\n      var parser = new DOMParser();\n      var doc = parser.parseFromString(string, \"text/html\");\n      return doc.body.childNodes;\n    }\n\n    // Otherwise, fallback to old-school method\n    var dom = document.createElement(\"div\");\n    dom.innerHTML = string;\n    return dom;\n  };\n\n  /**\n   * {mlang} searchex regex\n   */\n  const searchex = /{\\s*mlang\\s+((?:[a-z0-9_-]+)(?:\\s*,\\s*[a-z0-9_-]+\\s*)*)\\s*}(.*?){\\s*mlang\\s*}/gim;\n\n  /**\n   * Search for mlang tags\n   *\n   * The code for this js parser was adapted from filter/multilang2\n   *\n   * @param {string} text Text with {mlang}\n   * @returns {string}\n   */\n  const mlangparser = (text) => {\n\n    // Search for {mlang} not found.\n    if (\n      text.match(searchex) === null\n    ) {\n      return text;\n    }\n\n    // Replace callback for searchex results.\n    const replacecallback = (lang, match) => {\n      let blocklang = match.split(searchex)[1];\n      let blocktext = match.split(searchex)[2];\n      window.console.log(blocklang, blocktext);\n      if (blocklang === lang) {\n        return blocktext;\n      }\n      return '';\n    };\n\n    // Get searchex results.\n    let result = text.replace(searchex, (match) => {\n      let lang = config.lang;\n      return replacecallback(lang, match);\n    });\n\n    // Return the found string.\n    return result;\n  };\n\n  /**\n   * Switch Translation Language\n   */\n  let localeSwitcher = document.querySelector(\n    \".local-coursetranslator__localeswitcher\"\n  );\n  localeSwitcher.addEventListener(\"change\", (e) => {\n    let url = new URL(window.location.href);\n    let searchParams = url.searchParams;\n    searchParams.set(\"course_lang\", e.target.value);\n    let newUrl = url.toString();\n\n    window.location = newUrl;\n  });\n\n  /**\n   * Select All Checkbox\n   */\n  const selectAll = document.querySelector(\n    \".local-coursetranslator__select-all\"\n  );\n  if (config.autotranslate) {\n    selectAll.disabled = false;\n  }\n  selectAll.addEventListener(\"click\", (e) => {\n    // See if select all is checked\n    let checked = e.target.checked;\n    let checkboxes = document.querySelectorAll(\n      \".local-coursetranslator__checkbox\"\n    );\n\n    // Check/uncheck checkboxes\n    if (checked) {\n      checkboxes.forEach((e) => {\n        e.checked = true;\n      });\n    } else {\n      checkboxes.forEach((e) => {\n        e.checked = false;\n      });\n    }\n    toggleAutotranslateButton();\n  });\n\n  /**\n   * Autotranslate Checkboxes\n   */\n  const checkboxes = document.querySelectorAll(\n    \".local-coursetranslator__checkbox\"\n  );\n  if (config.autotranslate) {\n    checkboxes.forEach((e) => {\n      e.disabled = false;\n    });\n  }\n  checkboxes.forEach((e) => {\n    e.addEventListener(\"change\", () => {\n      toggleAutotranslateButton();\n    });\n  });\n\n  /**\n   * Autotranslate Button Display\n   * @returns void\n   */\n  const autotranslateButton = document.querySelector(\n    \".local-coursetranslator__autotranslate-btn\"\n  );\n\n  /**\n   * Toggle Autotranslate Button\n   */\n  const toggleAutotranslateButton = () => {\n    let checkboxItems = [];\n    checkboxes.forEach((e) => {\n      checkboxItems.push(e.checked);\n    });\n    let checked = checkboxItems.find((checked) => checked === true)\n      ? true\n      : false;\n    if (config.autotranslate && checked) {\n      autotranslateButton.disabled = false;\n    } else {\n      autotranslateButton.disabled = true;\n    }\n  };\n\n  /**\n   * Autotranslate Button Click\n   * @returns void\n   */\n  autotranslateButton.addEventListener(\"click\", () => {\n    document\n      .querySelectorAll(\".local-coursetranslator__checkbox:checked\")\n      .forEach((e) => {\n        let key = e.getAttribute(\"data-key\");\n        getTranslation(key);\n      });\n  });\n\n  /**\n   * Send for Translation to DeepL\n   * @param {Integer} key Translation Key\n   */\n  const getTranslation = (key) => {\n    // Get the editor\n    let editor = document.querySelector(\n      '.local-coursetranslator__editor[data-key=\"' + key + '\"] [contenteditable=\"true\"]'\n    );\n\n    // Get the source text\n    let sourceText = document.querySelector(\n      '[data-sourcetext-key=\"' + key + '\"]'\n    ).innerHTML;\n\n    // Build formData\n    let formData = new FormData();\n    formData.append(\"text\", sourceText);\n    formData.append(\"source_lang\", \"en\");\n    formData.append(\"target_lang\", config.lang);\n    formData.append(\"preserve_formatting\", 1);\n    formData.append(\"auth_key\", config.apikey);\n    formData.append(\"tag_handling\", \"xml\");\n    formData.append(\"split_sentences\", \"nonewlines\");\n\n    // Update the translation\n    let xhr = new XMLHttpRequest();\n    xhr.onreadystatechange = () => {\n      if (xhr.readyState === XMLHttpRequest.DONE) {\n        var status = xhr.status;\n        if (status === 0 || (status >= 200 && status < 400)) {\n          // The request has been completed successfully\n          let data = JSON.parse(xhr.responseText);\n          window.console.log(\"deepl:\", key, data);\n          // Display translation\n          editor.innerHTML = data.translations[0].text;\n          // Save translation\n          saveTranslation(key, editor, data.translations[0].text);\n        } else {\n          // Oh no! There has been an error with the request!\n          window.console.log(\"error\", status);\n        }\n      }\n    };\n    xhr.open(\"POST\", config.deeplurl);\n    xhr.send(formData);\n  };\n\n  /**\n   * Save Translation to Moodle\n   * @param  {String} key Data Key\n   * @param  {Node} editor HTML Editor Node\n   * @param  {String} text Updated Text\n   */\n  const saveTranslation = (key, editor, text) => {\n    let element = editor.closest(\".local-coursetranslator__editor\");\n    let id = element.getAttribute(\"data-id\");\n    let table = element.getAttribute(\"data-table\");\n    let field = element.getAttribute(\"data-field\");\n\n    // Updated hidden textarea with updatedtext\n    let textarea = document.querySelector('.local-coursetranslator__textarea[data-key=\"' + key + '\"]');\n    let updatedtext = getupdatedtext(textarea, text);\n    textarea.innerHTML = updatedtext;\n\n    // Build the data object\n    let data = {};\n    data.courseid = config.courseid;\n    data.id = parseInt(id);\n    data.table = table;\n    data.field = field;\n    data.text = updatedtext;\n\n    // Success Message\n    const successMessage = () => {\n      editor.classList.add(\"local-coursetranslator__success\");\n      // Add saved indicator\n      let indicator =\n        '<div class=\"local-coursetranslator__success-message\" data-key=\"' +\n        key +\n        '\">' +\n        autosavedMsg +\n        \"</div>\";\n      editor.after(...stringToHTML(indicator));\n\n      // Remove success message after a few seconds\n      setTimeout(() => {\n        let indicatorNode = document.querySelector(\n          '.local-coursetranslator__success-message[data-key=\"' + key + '\"]'\n        );\n        editor.parentNode.removeChild(indicatorNode);\n      }, 3000);\n    };\n\n    // Error Mesage\n    const errorMessage = (error) => {\n      window.console.log(error);\n      editor.classList.add(\"local-coursetranslator__error\");\n    };\n\n    // Submit the request\n    ajax.call([\n      {\n        methodname: \"local_coursetranslator_update_translation\",\n        args: {\n          data: [data],\n        },\n        done: (data) => {\n          window.console.log(\"ws: \", key, data);\n          if (data.length > 0) {\n            successMessage();\n            if (config.currentlang === config.lang) {\n              document.querySelector('[data-sourcetext-key=\"' + key + '\"]').innerHTML = text;\n            }\n          } else {\n            errorMessage();\n          }\n        },\n        fail: (error) => {\n          errorMessage(error);\n        },\n      },\n    ]);\n\n  };\n\n  /**\n   * Update Textarea\n   * @param {node} textarea Hidden Textara\n   * @param {string} text Text to update\n   * @returns {string}\n   */\n  const getupdatedtext = (textarea, text) => {\n    let lang = config.lang;\n\n    // Search for {mlang} not found.\n    let textareatext = textarea.innerHTML;\n    if (textareatext.indexOf('{mlang') === -1) {\n      if (lang === 'other') {\n        return '{mlang other}' + text + '{mlang}';\n      } else {\n        return '{mlang other}' + textareatext + '{mlang}{mlang ' + lang + '}' + text + '{mlang}';\n      }\n    }\n\n    // Use regex to replace the string\n    let pattern = `{*mlang +(${lang})}(.*?){*mlang*}`;\n    let replacex = new RegExp(pattern, 'gim');\n    let matches = textareatext.match(replacex);\n\n    // Return the updated string\n    if (!matches) {\n      return textareatext + '{mlang ' + lang + '}' + text + '{mlang}';\n    } else {\n      return textareatext.replace(replacex, '{mlang ' + lang + '}' + text + '{mlang}');\n    }\n  };\n\n  /**\n   * Get the Translation using Moodle Web Service\n   * @returns void\n   */\n  window.addEventListener('load', function() {\n    document\n      .querySelectorAll(\n        '.local-coursetranslator__editor [contenteditable=\"true\"]'\n      )\n      .forEach((editor) => {\n        // Save translation\n        editor.addEventListener(\"focusout\", () => {\n          // Get Processing Information\n          let text = editor.innerHTML;\n          let element = editor.closest(\".local-coursetranslator__editor\");\n          let key = element.getAttribute(\"data-key\");\n\n          saveTranslation(key, editor, text);\n        });\n\n        // Remove status classes\n        editor.addEventListener(\"click\", () => {\n          editor.classList.remove(\"local-coursetranslator__success\");\n          editor.classList.remove(\"local-coursetranslator__error\");\n        });\n      });\n  });\n\n  /**\n   * Get text from processing areas and add them to contenteditables\n   */\n  window.addEventListener('load', function() {\n    let textareas = document.querySelectorAll('.local-coursetranslator__textarea');\n    textareas.forEach(textarea => {\n      // Get relevent keys and text\n      let key = textarea.getAttribute('data-key');\n      let text = textarea.innerHTML;\n      let editor = document.querySelector('[data-key=\"' + key + '\"] [contenteditable=\"true\"]');\n      // Parse the text for mlang\n      let parsedtext = mlangparser(text);\n      // Updated contenteditables with parsedtext\n      editor.innerHTML = parsedtext;\n    });\n  });\n\n};\n"],"names":["config","autosavedMsg","str","get_string","done","string","searchex","mlangparser","text","match","replace","lang","blocklang","split","blocktext","window","console","log","replacecallback","document","querySelector","addEventListener","e","url","URL","location","href","searchParams","set","target","value","newUrl","toString","selectAll","autotranslate","disabled","checked","checkboxes","querySelectorAll","forEach","toggleAutotranslateButton","autotranslateButton","checkboxItems","push","find","key","getAttribute","getTranslation","editor","sourceText","innerHTML","formData","FormData","append","apikey","xhr","XMLHttpRequest","onreadystatechange","readyState","DONE","status","data","JSON","parse","responseText","translations","saveTranslation","open","deeplurl","send","element","closest","id","table","field","textarea","updatedtext","getupdatedtext","courseid","parseInt","successMessage","classList","add","indicator","after","DOMParser","parser","parseFromString","err","body","childNodes","dom","createElement","stringToHTML","setTimeout","indicatorNode","parentNode","removeChild","errorMessage","error","call","methodname","args","length","currentlang","fail","textareatext","indexOf","pattern","replacex","RegExp","remove","parsedtext"],"mappings":"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"}