define("local_coursetranslator/coursetranslator",["exports","core/ajax","./selectors","core/modal"],(function(_exports,_ajax,_selectors,_modal){function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}
/*
   * @module     local_coursetranslator/coursetranslator
   * @copyright  2022 Kaleb Heitzman <kaleb@jamfire.io>
   * @copyright  2024 Bruno Baudry <bruno.baudry@bfh.ch>
   * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
   */Object.defineProperty(_exports,"__esModule",{value:!0}),_exports.init=void 0,_ajax=_interopRequireDefault(_ajax),_selectors=_interopRequireDefault(_selectors),_modal=_interopRequireDefault(_modal);let tempTranslations={},mainEditorType="",config={},autotranslateButton={},checkboxes=[],sourceLang="",targetLang="",saveAllBtn={};_exports.init=cfg=>{config=cfg,config.debug>0&&(window.console.info("debugging coursetranslator"),window.console.info(config)),mainEditorType=config.userPrefs,(()=>{try{saveAllBtn=document.querySelector(_selectors.default.actions.saveAll),sourceLang=document.querySelector(_selectors.default.actions.sourceSwitcher).value,targetLang=document.querySelector(_selectors.default.actions.targetSwitcher).value,autotranslateButton=document.querySelector(_selectors.default.actions.autoTranslateBtn),checkboxes=document.querySelectorAll(_selectors.default.actions.checkBoxes),checkboxes.forEach((node=>tempTranslations[node.dataset.key]={}))}catch(e){config.debug&&window.console.error(e.message)}})(),document.addEventListener("change",(e=>{e.target.closest(_selectors.default.actions.targetSwitcher)&&switchTarget(e),e.target.closest(_selectors.default.actions.sourceSwitcher)&&switchSource(e),e.target.closest(_selectors.default.actions.showUpdated)&&showRows(_selectors.default.statuses.updated,e.target.checked),e.target.closest(_selectors.default.actions.showNeedUpdate)&&showRows(_selectors.default.statuses.needsupdate,e.target.checked),e.target.closest(_selectors.default.actions.checkBoxes)&&onItemChecked(e)})),document.addEventListener("click",(e=>{e.target.closest(_selectors.default.actions.toggleMultilang)&&onToggleMultilang(e.target.closest(_selectors.default.actions.toggleMultilang)),e.target.closest(_selectors.default.actions.autoTranslateBtn)&&(config.currentlang===config.lang||void 0===config.lang?_modal.default.create({title:"Cannot call deepl",body:"<p>Both languges are the same {$config.lang}</p>",show:!0,removeOnClose:!0}):doAutotranslate()),e.target.closest(_selectors.default.actions.selectAllBtn)&&toggleAllCheckboxes(e),e.target.closest(_selectors.default.actions.saveAll)&&document.querySelectorAll(_selectors.default.statuses.checkedCheckBoxes).forEach((e=>{const key=e.dataset.key;""!==tempTranslations[key].translation?saveTranslation(key):window.console.warn("not translated "+key)}))})),toggleAutotranslateButton();document.querySelector(_selectors.default.actions.selectAllBtn).disabled=sourceLang===targetLang;document.querySelectorAll(_selectors.default.actions.validatorsBtns).forEach((item=>{item.addEventListener("click",(e=>{let key=e.target.closest(_selectors.default.actions.validatorsBtns).dataset.keyValidator;null===tempTranslations[key]||void 0===tempTranslations[key]?window.console.warn(`Transaltion key "${key}" is undefined `):saveTranslation(key)}))})),checkboxes.forEach((e=>{e.disabled=sourceLang===targetLang,e.addEventListener("click",(()=>{toggleAutotranslateButton()}))}))};const saveTranslation=key=>{let editor=tempTranslations[key].editor,text=editor.innerHTML,sourceText=tempTranslations[key].source,icon=document.querySelector(replaceKey(_selectors.default.actions.validatorBtn,key)),selector=_selectors.default.editors.multiples.editorsWithKey.replace("<KEY>",key),element=document.querySelector(selector),id=element.getAttribute("data-id"),tid=element.getAttribute("data-tid"),table=element.getAttribute("data-table"),field=element.getAttribute("data-field"),fielddata={};fielddata.courseid=config.courseid,fielddata.id=parseInt(id),fielddata.table=table,fielddata.field=field,config.debug>0&&window.console.info(fielddata),_ajax.default.call([{methodname:"local_coursetranslator_get_field",args:{data:[fielddata]},done:data=>{let fieldtext=data[0].text;if(data.length>0){let textarea=document.querySelector(_selectors.default.editors.multiples.textAreas.replace("<KEY>",key)),updatedtext=getupdatedtext(fieldtext,text,sourceText),tdata={};tdata.courseid=config.courseid,tdata.id=parseInt(id),tdata.tid=tid,tdata.table=table,tdata.field=field,tdata.text=updatedtext,config.debug>0&&window.console.info(tdata);const successMessage=()=>{element.classList.add("local-coursetranslator__success"),setIconStatus(icon,_selectors.default.statuses.success),setTimeout((()=>{let multilangPill=document.querySelector(replaceKey(_selectors.default.statuses.multilang,key));document.querySelector(replaceKey(_selectors.default.statuses.prevTransStatus,key)).classList="badge badge-pill badge-success",multilangPill.classList.contains("invisible")&&multilangPill.classList.remove("invisible"),setIconStatus(icon,_selectors.default.statuses.saved)}))},errorMessage=error=>{editor.classList.add("local-coursetranslator__error"),setIconStatus(icon,_selectors.default.statuses.failed),error&&(textarea.innerHTML=error)};_ajax.default.call([{methodname:"local_coursetranslator_update_translation",args:{data:[tdata]},done:data=>{config.debug>0&&window.console.info("ws: ",key,data),data.length>0?(successMessage(),textarea.innerHTML=data[0].text,config.currentlang===config.lang&&(document.querySelector(_selectors.default.sourcetexts.keys.replace("<KEY>",key)).innerHTML=text)):errorMessage()},fail:error=>{errorMessage(error)}}])}else window.console.warn(data)},fail:error=>{window.console.warn(error)}}])},getupdatedtext=(fieldtext,text,source)=>{let targetlang=targetLang,otherlangtext=`{mlang other}${source}{mlang}`,targetLangTag=`{mlang ${targetlang}}`,targetlangtext=`${targetLangTag}${text}{mlang}`;if(config.debug>0&&(window.console.info("targetlang",targetlang),window.console.info("startOther","{mlang other}"),window.console.info("otherlangtext",otherlangtext),window.console.info("targetLangTag",targetLangTag),window.console.info("targetlangtext",targetlangtext),window.console.info("fieldtext",fieldtext),window.console.info("text",text),window.console.info("source",source)),-1===fieldtext.indexOf("{mlang"))return otherlangtext+targetlangtext;let alllangregex=new RegExp("({mlang [a-z]{2,5}})(.*?){mlang}","gs"),all={},tagReg=new RegExp("{mlang (other|[a-z]{2})}",""),splited=fieldtext.split(alllangregex);config.debug>0&&window.console.info("SPLITED",splited);let foundsourcetag="";var l="";for(var i in splited)""!==splited[i]&&(splited[i].match(tagReg)?l=splited[i].match(tagReg)[0]:""!==l&&(all[l]=splited[i],splited[i]===source&&(foundsourcetag=l),l=""));"{mlang other}"!==foundsourcetag&&delete all[foundsourcetag],all["{mlang other}"]=source,all[targetLangTag]=text;let s="";for(let tag in all)s+=tag+all[tag]+"{mlang}";return s},onItemChecked=e=>{toggleStatus(e.target.getAttribute("data-key"),e.target.checked)},toggleStatus=(key,checked)=>{var _tempTranslations$key,_tempTranslations$key2;const icon=document.querySelector(replaceKey(_selectors.default.actions.validatorBtn,key));switch(icon.dataset.status){case _selectors.default.statuses.wait:checked&&setIconStatus(icon,_selectors.default.statuses.totranslate);break;case _selectors.default.statuses.totranslate:checked&&(null===(_tempTranslations$key=tempTranslations[key])||void 0===_tempTranslations$key||null===(_tempTranslations$key2=_tempTranslations$key.translation)||void 0===_tempTranslations$key2?void 0:_tempTranslations$key2.length)>0?setIconStatus(icon,_selectors.default.statuses.tosave,!0):setIconStatus(icon,_selectors.default.statuses.wait);break;case _selectors.default.statuses.tosave:checked||setIconStatus(icon,_selectors.default.statuses.totranslate);case _selectors.default.statuses.failed:case _selectors.default.statuses.success:case _selectors.default.statuses.saved:}},setIconStatus=function(icon){let s=arguments.length>1&&void 0!==arguments[1]?arguments[1]:_selectors.default.statuses.wait,isBtn=arguments.length>2&&void 0!==arguments[2]&&arguments[2];isBtn?(icon.classList.contains("btn")||icon.classList.add("btn"),icon.classList.contains("disable")&&icon.classList.remove("disable")):(icon.classList.contains("disable")||icon.classList.add("disable"),icon.classList.contains("btn")&&icon.classList.remove("btn")),icon.setAttribute("role",isBtn?"button":"status"),icon.setAttribute("data-status",s)},showRows=(selector,selected)=>{document.querySelectorAll(selector).forEach((item=>{let k=item.getAttribute("data-row-id");toggleRowVisibility(item,selected),item.querySelector(replaceKey(_selectors.default.editors.multiples.checkBoxesWithKey,k)).checked=!1,toggleStatus(k,!1)})),toggleAutotranslateButton()},toggleRowVisibility=(row,checked)=>{checked?row.classList.remove("d-none"):row.classList.add("d-none")},switchTarget=e=>{let url=new URL(window.location.href);url.searchParams.set("target_lang",e.target.value),window.location=url.toString()},switchSource=e=>{let url=new URL(window.location.href);url.searchParams.set("lang",e.target.value),window.location=url.toString()},doAutotranslate=()=>{saveAllBtn.hidden=saveAllBtn.disabled=!1,document.querySelectorAll(_selectors.default.statuses.checkedCheckBoxes).forEach((ckBox=>{let key=ckBox.getAttribute("data-key");getTranslation(key)}))},getTranslation=key=>{tempTranslations[key]={};let editorSettings=findEditor(key);config.debug>0&&window.console.info(editorSettings);let editor=editorSettings.editor,editorType=editorSettings.editorType,sourceText=document.querySelector(_selectors.default.sourcetexts.keys.replace("<KEY>",key)).getAttribute("data-sourcetext-raw"),icon=document.querySelector(replaceKey(_selectors.default.actions.validatorBtn,key));tempTranslations[key]={editorType:editorType,editor:editor,source:sourceText,status:_selectors.default.statuses.wait,translation:""};let formData=new FormData;formData.append("text",sourceText),formData.append("source_lang",sourceLang.toUpperCase()),formData.append("target_lang",targetLang.toUpperCase()),formData.append("auth_key",config.apikey),formData.append("tag_handling",document.querySelector(_selectors.default.deepl.tagHandling).checked?"html":"xml"),formData.append("context",document.querySelector(_selectors.default.deepl.context).value??null),formData.append("split_sentences",document.querySelector(_selectors.default.deepl.splitSentences).value),formData.append("preserve_formatting",document.querySelector(_selectors.default.deepl.preserveFormatting).checked),formData.append("formality",document.querySelector('[name="local-coursetranslator/formality"]:checked').value),formData.append("glossary_id",document.querySelector(_selectors.default.deepl.glossaryId).value),formData.append("outline_detection",document.querySelector(_selectors.default.deepl.outlineDetection).checked),formData.append("non_splitting_tags",toJsonArray(document.querySelector(_selectors.default.deepl.nonSplittingTags).value)),formData.append("splitting_tags",toJsonArray(document.querySelector(_selectors.default.deepl.splittingTags).value)),formData.append("ignore_tags",toJsonArray(document.querySelector(_selectors.default.deepl.ignoreTags).value)),config.debug&&window.console.info("Send deepl:",formData);let xhr=new XMLHttpRequest;xhr.onreadystatechange=()=>{if(xhr.readyState===XMLHttpRequest.DONE){const status=xhr.status;if(0===status||status>=200&&status<400){let data=JSON.parse(xhr.responseText);editor.innerHTML=data.translations[0].text,tempTranslations[key].translation=data.translations[0].text,setIconStatus(icon,_selectors.default.statuses.tosave,!0),injectImageCss(editorSettings)}else setIconStatus(icon,_selectors.default.statuses.failed,!1)}},xhr.open("POST",config.deeplurl),xhr.send(formData)},injectImageCss=editorSettings=>{const css=document.createElement("style");if(css.textContent="img{background-color:yellow !important;font-style: italic;}","iframe"===editorSettings.editorType){let editorschildrens=Array.from(editorSettings.editor.parentElement.children),found=!1;for(let j in editorschildrens){if(editorschildrens[j].innerText===css.innerText){found=!0;break}}found||editorSettings.editor.parentElement.appendChild(css)}},findEditor=key=>{let e=document.querySelector(_selectors.default.editors.types.basic.replace("<KEY>",key)),et="basic";if(null===e)switch(mainEditorType){case"atto":et="iframe",e=document.querySelector(_selectors.default.editors.types.atto.replaceAll("<KEY>",key));break;case"tiny":et="iframe",e=document.querySelector(_selectors.default.editors.types.tiny.replaceAll("<KEY>",key)).contentWindow.tinymce;break;case"marklar":case"textarea":e=document.querySelector(_selectors.default.editors.types.other.replaceAll("<KEY>",key))}return{editor:e,editorType:et}},toggleAllCheckboxes=e=>{e.target.checked?checkboxes.forEach((i=>{i.checked=!getParentRow(i).classList.contains("d-none"),toggleStatus(i.getAttribute("data-key"),i.checked)})):checkboxes.forEach((i=>{i.checked=!1,toggleStatus(i.getAttribute("data-key"),!1)})),toggleAutotranslateButton()},getParentRow=node=>node.closest(replaceKey(_selectors.default.sourcetexts.parentrow,node.getAttribute("data-key"))),toggleAutotranslateButton=()=>{autotranslateButton.disabled=!0;for(let i in checkboxes){if(checkboxes[i].checked){autotranslateButton.disabled=!1;break}}},onToggleMultilang=e=>{e.classList.toggle("showing");let keyid=e.getAttribute("aria-controls"),key=keyidToKey(keyid),source=document.querySelector(replaceKey(_selectors.default.sourcetexts.keys,key)),multilang=document.querySelector(replaceKey(_selectors.default.sourcetexts.multilangs,keyid));source.classList.toggle("show"),multilang.classList.toggle("show")},toJsonArray=function(s){let sep=arguments.length>1&&void 0!==arguments[1]?arguments[1]:",";return JSON.stringify(s.split(sep))},replaceKey=(s,k)=>s.replace("<KEY>",k),keyidToKey=k=>{let m=k.match(/^(.+)-(.+)-(.+)$/i);return`${m[1]}[${m[2]}][${m[3]}]`}}));

//# sourceMappingURL=coursetranslator.min.js.map